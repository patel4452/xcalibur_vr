<?php

function genemy_import_demo_data() {

  return array( 
    array(
      'import_file_name'           => 'Business Multipurpose',
      'categories'                 => array( 'Multi pages' ),
      'import_file_url'            => GENEMY_URI.'/admin/demo-data/demo-content.xml',
      'import_widget_file_url'     => GENEMY_URI.'/admin/demo-data/widgets.wie',
       
      'import_preview_image_url'   => '//jthemes.org/wp/genemy/assests/images/layout-6.jpg',
      'preview_url'                => '//jthemes.org/wp/genemy/creative',
    ),   
    array(
      'import_file_name'           => '01- Default Landing',
      'categories'                 => array( 'Landing pages' ),
      'import_file_url'            => GENEMY_URI.'/admin/demo-data/demo-content.xml',
      'import_widget_file_url'     => GENEMY_URI.'/admin/demo-data/widgets.wie',
       
      'import_preview_image_url'   => '//jthemes.org/wp/genemy/assests/images/layout-1.jpg',
      'preview_url'                => '//jthemes.org/wp/genemy/creative/default-landing',
    ),
    array(
      'import_file_name'           => '02- Creative Agency',
      'categories'                 => array( 'Landing pages' ),
      'import_file_url'            => GENEMY_URI.'/admin/demo-data/demo-content.xml',
      'import_widget_file_url'     => GENEMY_URI.'/admin/demo-data/widgets.wie',
       
      'import_preview_image_url'   => '//jthemes.org/wp/genemy/assests/images/layout-2.jpg',
      'preview_url'                => '//jthemes.org/wp/genemy/creative/creative-agency',
    ),
    array(
      'import_file_name'           => '03- Startup Agency',
      'categories'                 => array( 'Landing pages' ),
      'import_file_url'            => GENEMY_URI.'/admin/demo-data/demo-content.xml',
      'import_widget_file_url'     => GENEMY_URI.'/admin/demo-data/widgets.wie',
       
      'import_preview_image_url'   => '//jthemes.org/wp/genemy/assests/images/layout-3.jpg',
      'preview_url'                => '//jthemes.org/wp/genemy/creative/startup-agency',
    ),
    array(
      'import_file_name'           => '04- Design Studio',
      'categories'                 => array( 'Landing pages' ),
      'import_file_url'            => GENEMY_URI.'/admin/demo-data/demo-content.xml',
      'import_widget_file_url'     => GENEMY_URI.'/admin/demo-data/widgets.wie',
       
      'import_preview_image_url'   => '//jthemes.org/wp/genemy/assests/images/layout-4.jpg',
      'preview_url'                => '//jthemes.org/wp/genemy/creative/design-studio',
    ),
    array(
      'import_file_name'           => '05- Digital Agency',
      'categories'                 => array( 'Landing pages' ),
      'import_file_url'            => GENEMY_URI.'/admin/demo-data/demo-content.xml',
      'import_widget_file_url'     => GENEMY_URI.'/admin/demo-data/widgets.wie',
       
      'import_preview_image_url'   => '//jthemes.org/wp/genemy/assests/images/layout-5.jpg',
      'preview_url'                => '//jthemes.org/wp/genemy/creative/digital-agency',
    ),
    array(
      'import_file_name'           => '06- Business Multipurpose',
      'categories'                 => array( 'Landing pages' ),
      'import_file_url'            => GENEMY_URI.'/admin/demo-data/demo-content.xml',
      'import_widget_file_url'     => GENEMY_URI.'/admin/demo-data/widgets.wie',
       
      'import_preview_image_url'   => '//jthemes.org/wp/genemy/assests/images/layout-6.jpg',
      'preview_url'                => '//jthemes.org/wp/genemy/creative/business-multipurpose',
    ),
    array(
      'import_file_name'           => '07- Marketing Agency',
      'categories'                 => array( 'Landing pages' ),
      'import_file_url'            => GENEMY_URI.'/admin/demo-data/demo-content.xml',
      'import_widget_file_url'     => GENEMY_URI.'/admin/demo-data/widgets.wie',
       
      'import_preview_image_url'   => '//jthemes.org/wp/genemy/assests/images/layout-7.jpg',
      'preview_url'                => '//jthemes.org/wp/genemy/creative/marketing-agency',
    ),
    array(
      'import_file_name'           => '08- App Showcase',
      'categories'                 => array( 'App', 'Landing pages' ),
      'import_file_url'            => GENEMY_URI.'/admin/demo-data/demo-content.xml',
      'import_widget_file_url'     => GENEMY_URI.'/admin/demo-data/widgets.wie',
       
      'import_preview_image_url'   => '//jthemes.org/wp/genemy/assests/images/layout-8.jpg',
      'preview_url'                => '//jthemes.org/wp/genemy/creative/app-showcase',
    ),
    array(
      'import_file_name'           => '09- Innovation Agency',
      'categories'                 => array( 'Landing pages' ),
      'import_file_url'            => GENEMY_URI.'/admin/demo-data/demo-content.xml',
      'import_widget_file_url'     => GENEMY_URI.'/admin/demo-data/widgets.wie',
       
      'import_preview_image_url'   => '//jthemes.org/wp/genemy/assests/images/layout-9.jpg',
      'preview_url'                => '//jthemes.org/wp/genemy/creative/innovation-agency',
    ),
    array(
      'import_file_name'           => '10- Portfolio Minimal',
      'categories'                 => array( 'Freelancer', 'Landing pages' ),
      'import_file_url'            => GENEMY_URI.'/admin/demo-data/demo-content.xml',
      'import_widget_file_url'     => GENEMY_URI.'/admin/demo-data/widgets.wie',
       
      'import_preview_image_url'   => '//jthemes.org/wp/genemy/assests/images/layout-10.jpg',
      'preview_url'                => '//jthemes.org/wp/genemy/creative/portfolio-minimal',
    ),
    array(
      'import_file_name'           => '11- Creative Business',
      'categories'                 => array( 'Landing pages' ),
      'import_file_url'            => GENEMY_URI.'/admin/demo-data/demo-content.xml',
      'import_widget_file_url'     => GENEMY_URI.'/admin/demo-data/widgets.wie',
       
      'import_preview_image_url'   => '//jthemes.org/wp/genemy/assests/images/layout-11.jpg',
      'preview_url'                => '//jthemes.org/wp/genemy/creative/creative-business',
    ),
    array(
      'import_file_name'           => '12- Business Agency',
      'categories'                 => array( 'Landing pages' ),
      'import_file_url'            => GENEMY_URI.'/admin/demo-data/demo-content.xml',
      'import_widget_file_url'     => GENEMY_URI.'/admin/demo-data/widgets.wie',
       
      'import_preview_image_url'   => '//jthemes.org/wp/genemy/assests/images/layout-12.jpg',
      'preview_url'                => '//jthemes.org/wp/genemy/creative/business-agency',
    ),
    array(
      'import_file_name'           => '13- Freelancer',
      'categories'                 => array( 'Freelancer', 'Landing pages' ),
      'import_file_url'            => GENEMY_URI.'/admin/demo-data/demo-content.xml',
      'import_widget_file_url'     => GENEMY_URI.'/admin/demo-data/widgets.wie',
       
      'import_preview_image_url'   => '//jthemes.org/wp/genemy/assests/images/layout-13.jpg',
      'preview_url'                => '//jthemes.org/wp/genemy/creative/freelancer',
    ),
    array(
      'import_file_name'           => '14 – App Landing',
      'categories'                 => array( 'App', 'Landing pages' ),
      'import_file_url'            => GENEMY_URI.'/admin/demo-data/demo-content.xml',
      'import_widget_file_url'     => GENEMY_URI.'/admin/demo-data/widgets.wie',
       
      'import_preview_image_url'   => '//jthemes.org/wp/genemy/assests/images/layout-14.jpg',
      'preview_url'                => '//jthemes.org/wp/genemy/creative/app-landing',
    ),

  );

}

add_filter( 'pt-ocdi/import_files', 'genemy_import_demo_data' );


function genemy_after_import_setup() {
  // Assign menus to their locations.
  $primary = get_term_by( 'name', 'Header menu', 'nav_menu' );

  set_theme_mod( 'nav_menu_locations', array(
        'primary' => $primary->term_id,
        //'footer' => $footer->term_id,
      )
  );

  // Assign front page and posts page (blog page).
  $front_page_id = get_page_by_title( 'Home' );
  $blog_page_id  = get_page_by_title( 'Blog' );

  update_option( 'show_on_front', 'page' );
  update_option( 'page_on_front', $front_page_id->ID );
  update_option( 'page_for_posts', $blog_page_id->ID );

  genemy_set_clean_content_by_post_type('page', array(
      'search' => 'http://localhost/jtheme/genemy/wp/wp-content/themes/genemy',
      'replace' => get_template_directory_uri(),
    ));

  genemy_set_clean_content_by_post_type('page', array(
      'search' => 'http://jthemes.org/wp/genemy/creative/wp-content/themes/genemy',
      'replace' => get_template_directory_uri(),
    ));
  

}
add_action( 'pt-ocdi/after_import', 'genemy_after_import_setup' );

function genemy_after_import( $selected_import ) {

 

  $pagename = '01- Default Landing';
  if ( $pagename === $selected_import['import_file_name'] ) {
      $front_page_id = get_page_by_title( $pagename );
      update_option( 'show_on_front', 'page' );
      update_option( 'page_on_front', $front_page_id->ID );
  }

  $pagename = '02- Creative Agency';
  if ( $pagename === $selected_import['import_file_name'] ) {
      $front_page_id = get_page_by_title( $pagename );
      update_option( 'show_on_front', 'page' );
      update_option( 'page_on_front', $front_page_id->ID );
  }

  $pagename = '03- Startup Agency';
  if ( $pagename === $selected_import['import_file_name'] ) {
      $front_page_id = get_page_by_title( $pagename );
      update_option( 'show_on_front', 'page' );
      update_option( 'page_on_front', $front_page_id->ID );
  }

  $pagename = '04-Design Studio';
  if ( $pagename === $selected_import['import_file_name'] ) {
      $front_page_id = get_page_by_title( $pagename );
      update_option( 'show_on_front', 'page' );
      update_option( 'page_on_front', $front_page_id->ID );
  }

  $pagename = '05-Digital Agency';
  if ( $pagename === $selected_import['import_file_name'] ) {
      $front_page_id = get_page_by_title( $pagename );
      update_option( 'show_on_front', 'page' );
      update_option( 'page_on_front', $front_page_id->ID );
  }

  $pagename = '06-Business Multipurpose';
  if ( $pagename === $selected_import['import_file_name'] ) {
      $front_page_id = get_page_by_title( $pagename );
      update_option( 'show_on_front', 'page' );
      update_option( 'page_on_front', $front_page_id->ID );
  }

  $pagename = '07- Marketing Agency';
  if ( $pagename === $selected_import['import_file_name'] ) {
      $front_page_id = get_page_by_title( $pagename );
      update_option( 'show_on_front', 'page' );
      update_option( 'page_on_front', $front_page_id->ID );
  }

  $pagename = '08- App Showcase';
  if ( $pagename === $selected_import['import_file_name'] ) {
      $front_page_id = get_page_by_title( $pagename );
      update_option( 'show_on_front', 'page' );
      update_option( 'page_on_front', $front_page_id->ID );
  }

  $pagename = '09- Innovation Agency';
  if ( $pagename === $selected_import['import_file_name'] ) {
      $front_page_id = get_page_by_title( $pagename );
      update_option( 'show_on_front', 'page' );
      update_option( 'page_on_front', $front_page_id->ID );
  }

  $pagename = '10- Portfolio Minimal';
  if ( $pagename === $selected_import['import_file_name'] ) {
      $front_page_id = get_page_by_title( $pagename );
      update_option( 'show_on_front', 'page' );
      update_option( 'page_on_front', $front_page_id->ID );
  }

  $pagename = '11- Creative Business';
  if ( $pagename === $selected_import['import_file_name'] ) {
      $front_page_id = get_page_by_title( $pagename );
      update_option( 'show_on_front', 'page' );
      update_option( 'page_on_front', $front_page_id->ID );
  }

  $pagename = '12- Business Agency';
  if ( $pagename === $selected_import['import_file_name'] ) {
      $front_page_id = get_page_by_title( $pagename );
      update_option( 'show_on_front', 'page' );
      update_option( 'page_on_front', $front_page_id->ID );
  }

  $pagename = '13- Freelancer';
  if ( $pagename === $selected_import['import_file_name'] ) {
      $front_page_id = get_page_by_title( $pagename );
      update_option( 'show_on_front', 'page' );
      update_option( 'page_on_front', $front_page_id->ID );
  }

  $pagename = '14 – App Landing';
  if ( $pagename === $selected_import['import_file_name'] ) {
      $front_page_id = get_page_by_title( $pagename );
      update_option( 'show_on_front', 'page' );
      update_option( 'page_on_front', $front_page_id->ID );
  }
  
}
//pt-ocdi/after_import
add_action( 'pt-ocdi/after_import', 'genemy_after_import' );


function perch_get_server_database_version() {
  global $wpdb;

  if ( empty( $wpdb->is_mysql ) ) {
    return array(
      'string' => '',
      'number' => '',
    );
  }

  if ( $wpdb->use_mysqli ) {
    $server_info = mysqli_get_server_info( $wpdb->dbh ); // @codingStandardsIgnoreLine.
  } else {
    $server_info = mysql_get_server_info( $wpdb->dbh ); // @codingStandardsIgnoreLine.
  }

  return array(
    'string' => $server_info,
    'number' => preg_replace( '/([^\d.]+).*/', '', $server_info ),
  );
}
function perch_let_to_num( $size ) {
  $l    = substr( $size, -1 );
  $ret  = substr( $size, 0, -1 );
  $byte = 1024;

  switch ( strtoupper( $l ) ) {
    case 'P':
      $ret *= 1024;
      // No break.
    case 'T':
      $ret *= 1024;
      // No break.
    case 'G':
      $ret *= 1024;
      // No break.
    case 'M':
      $ret *= 1024;
      // No break.
    case 'K':
      $ret *= 1024;
      // No break.
  }
  return $ret;
}
function perch_get_server_system_status(){
  global $wpdb;

    // Figure out cURL version, if installed.
    $curl_version = '';
    if ( function_exists( 'curl_version' ) ) {
      $curl_version = curl_version();
      $curl_version = $curl_version['version'] . ', ' . $curl_version['ssl_version'];
    }

    // WP memory limit.
    $wp_memory_limit = perch_let_to_num( WP_MEMORY_LIMIT );
    if ( function_exists( 'memory_get_usage' ) ) {
      $wp_memory_limit = max( $wp_memory_limit, perch_let_to_num( @ini_get( 'memory_limit' ) ) );
    }

    

    $database_version = perch_get_server_database_version();

    // Return all environment info. Described by JSON Schema.
    return array(
      'home_url'                  => get_option( 'home' ),
      'site_url'                  => get_option( 'siteurl' ),
      'wp_version'                => get_bloginfo( 'version' ),
      'wp_multisite'              => is_multisite(),
      'wp_memory_limit'           => $wp_memory_limit,
      'wp_debug_mode'             => ( defined( 'WP_DEBUG' ) && WP_DEBUG ),
      'wp_cron'                   => ! ( defined( 'DISABLE_WP_CRON' ) && DISABLE_WP_CRON ),
      'language'                  => get_locale(),
      'external_object_cache'     => wp_using_ext_object_cache(),     
      'php_version'               => phpversion(),
      'php_post_max_size'         => perch_let_to_num( ini_get( 'post_max_size' ) ),
      'php_max_execution_time'    => ini_get( 'max_execution_time' ),
      'php_max_input_vars'        => ini_get( 'max_input_vars' ),
      'curl_version'              => $curl_version,
      'suhosin_installed'         => extension_loaded( 'suhosin' ),
      'max_upload_size'           => wp_max_upload_size(),
      'mysql_version'             => $database_version['number'],
      'mysql_version_string'      => $database_version['string'],
      'default_timezone'          => date_default_timezone_get(),
      'fsockopen_or_curl_enabled' => ( function_exists( 'fsockopen' ) || function_exists( 'curl_init' ) ),
      'soapclient_enabled'        => class_exists( 'SoapClient' ),
      'domdocument_enabled'       => class_exists( 'DOMDocument' ),
      'gzip_enabled'              => is_callable( 'gzopen' ),
      'mbstring_enabled'          => extension_loaded( 'mbstring' ),      
    );
}
function appset_get_server_invironment( $type= '' ){

    $environment      = perch_get_server_system_status();
    if( $type == 'wp_memory_limit' ){
      if ( $environment['wp_memory_limit'] < 67108864 ) {        
          return '<mark class="no"><span class="dashicons dashicons-warning"></span>' . esc_html( size_format( $environment['wp_memory_limit'] ) ) . '</mark>';
        } else {
          return '<mark class="yes"><span class="dashicons dashicons-yes"></span>' . esc_html( size_format( $environment['wp_memory_limit'] ) ) . '</mark>';
        }
    }

    if( $type == 'max_upload_size' ){
      if ( $environment['max_upload_size'] < 67108864 ) {
         return '<mark class="no"><span class="dashicons dashicons-warning"></span>' . esc_html( size_format( $environment['max_upload_size'] ) ) . '</mark>';
      }else{
         return '<mark class="yes"><span class="dashicons dashicons-yes"></span>' . esc_html( size_format( $environment['max_upload_size'] ) ) . '</mark>';
      }      
    }

    if( $type == 'php_post_max_size' ){
      if ( $environment['php_post_max_size'] < 268435456 ) {
         return '<mark class="no"><span class="dashicons dashicons-warning"></span>' . esc_html( size_format( $environment['php_post_max_size'] ) ) . '</mark>';
      }else{
         return '<mark class="yes"><span class="dashicons dashicons-yes"></span>' . esc_html( size_format( $environment['php_post_max_size'] ) ) . '</mark>';
      }      
    }

    if( $type == 'php_max_execution_time' ){
      if ( $environment['php_max_execution_time'] < 300 ) {
         return '<mark class="no"><span class="dashicons dashicons-warning"></span>' . esc_html( $environment['php_max_execution_time'] ) . '</mark>';
      }else{
         return '<mark class="yes"><span class="dashicons dashicons-yes"></span>' . esc_html( $environment['php_max_execution_time'] ) . '</mark>';
      }      
    } 

    if( $type == 'php_version' ){
      if ( version_compare( $environment['php_version'], '5.6', '>=' ) ) {
         return '<mark class="yes"><span class="dashicons dashicons-yes"></span>' . esc_html( $environment['php_version'] ) . '</mark>';         
      }else{
        return '<mark class="no"><span class="dashicons dashicons-warning"></span>' . esc_html( $environment['php_version'] ) . '</mark>';
      }      
    }  
 
}

function appset_intro_text( $default_text ) {
  $default_text .= '<div class="ocdi__intro-text"><table class="widefat">
  <thead><tr>
  <th><h3>Check your server settings</h3></th>
  <th><h3>Common error</h3></th>
  </tr></thead>
  <tbody><tr><td>
  <p>Deactivate all cache plugin before import demo data.</p>
   <p>These defaults are not perfect and it depends on how large of an import you are making. So the bigger the import, the higher the numbers should be.</p>
  <ul>
    <li>PHP version (minimam 7.2+) '.appset_get_server_invironment("php_version").'</li> 
    <li>upload_max_filesize (64MB) '.appset_get_server_invironment("max_upload_size").'</li>    
    <li>memory_limit (256MB) '.appset_get_server_invironment("wp_memory_limit").'</li>
    <li>max_execution_time (300) '.appset_get_server_invironment("php_max_execution_time").'</li>
    <li>post_max_size (64MB) '.appset_get_server_invironment("php_post_max_size").'</li>    
    </ul>
    
    </td><td>
    <h3>Server error 500</h3>
   <p>This usually indicates a poor server configuration, usually on a cheap shared hosting (low values for PHP settings, missing PHP modules, and so on.</p>
   <p>There are two things you can do. You can contact with <strong><a target="_blank" href="https://themeforest.net/user/jthemes#contact">JThemes</a></strong> with <u>FTP/cPanel & wp-admin accessinfo</u> or you can contact your hosting support and ask them to update some PHP settings for your site.</p>
    <h3>Server error 504 - Gateway timeout</h3>
   <p>This means, that the server did not get a timely response and so it stopped with the current import. What you can try is to run the same import again. If you get the same error, you can try to run the same import a few times. A couple of import tries might finish the import till the end, becaue your server will be able to process the import data in smaller chunks.</p>
   </td>
   </tr></tbody>
   </table>
  </div>';

  return $default_text;
}
add_filter( 'pt-ocdi/plugin_intro_text', 'appset_intro_text' );

